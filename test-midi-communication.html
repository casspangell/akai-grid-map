<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIDI Communication Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: #ffffff;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            background: #2a2a2a;
            border: 2px solid #3a3a3a;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .test-button {
            background: #4a4a4a;
            border: 2px solid #5a5a5a;
            color: #ffffff;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 5px;
            transition: all 0.2s ease;
        }
        .test-button:hover {
            background: #5a5a5a;
            transform: scale(1.05);
        }
        .test-button.active {
            background: #51cf66;
            border-color: #40c057;
        }
        .test-button.failed {
            background: #ff6b6b;
            border-color: #e55353;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            font-weight: bold;
        }
        .test-result.pass {
            background: rgba(81, 207, 102, 0.2);
            border: 1px solid #51cf66;
            color: #51cf66;
        }
        .test-result.fail {
            background: rgba(255, 107, 107, 0.2);
            border: 1px solid #ff6b6b;
            color: #ff6b6b;
        }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(8, 40px);
            gap: 5px;
            margin: 20px 0;
        }
        .test-pad {
            width: 40px;
            height: 40px;
            background: #3a3a3a;
            border: 2px solid #4a4a4a;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: #b0b0b0;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .test-pad:hover {
            background: #4a4a4a;
            border-color: #5a5a5a;
        }
        .test-pad.active {
            background: #51cf66;
            border-color: #40c057;
        }
        .test-pad.clicked {
            background: #ff6b6b;
            border-color: #e55353;
        }
        .log {
            background: #1a1a1a;
            border: 1px solid #3a3a3a;
            border-radius: 4px;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>MIDI Communication Test Suite</h1>
    <p><strong>Purpose:</strong> Ensure bidirectional MIDI communication between web app and physical controller is working correctly.</p>
    
    <div class="test-section">
        <h2>üîß Test Controls</h2>
        <button class="test-button" onclick="runAllTests()">Run All Tests</button>
        <button class="test-button" onclick="clearLog()">Clear Log</button>
        <button class="test-button" onclick="testWebAppToController()">Test Web App ‚Üí Controller</button>
        <button class="test-button" onclick="testControllerToWebApp()">Test Controller ‚Üí Web App</button>
        <button class="test-button" onclick="testBidirectional()">Test Bidirectional</button>
    </div>

    <div class="test-section">
        <h2>üìä Test Results</h2>
        <div id="testResults"></div>
    </div>

    <div class="test-section">
        <h2>üéõÔ∏è Test Grid (MIDI Notes 0-7)</h2>
        <div class="test-grid" id="testGrid"></div>
        <p><small>Click these buttons to test Web App ‚Üí Controller communication</small></p>
    </div>

    <div class="test-section">
        <h2>üìù Test Log</h2>
        <div class="log" id="testLog"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/webmidi@3.1.6/dist/iife/webmidi.iife.min.js"></script>
    <script>
        let midiOutputs = [];
        let testResults = [];
        let testGrid = {};

        // Initialize WebMidi
        WebMidi.enable()
            .then(() => {
                log('‚úÖ WebMidi initialized successfully');
                setupMIDI();
            })
            .catch(err => {
                log('‚ùå WebMidi initialization failed: ' + err);
            });

        function setupMIDI() {
            // Setup inputs
            WebMidi.inputs.forEach(input => {
                input.addListener('noteon', handleMIDIMessage);
                input.addListener('noteoff', handleMIDIMessage);
                log(`üéπ Listening to MIDI input: ${input.name}`);
            });

            // Setup outputs
            midiOutputs = WebMidi.outputs;
            log(`üîä Found ${midiOutputs.length} MIDI output devices`);
        }

        function handleMIDIMessage(message) {
            const timestamp = new Date().toLocaleTimeString();
            let messageText = '';
            
            if (message.type === 'noteon') {
                messageText = `Note On: ${message.note.number}, Velocity: ${message.velocity}`;
                updateTestGrid(message.note.number, true);
                log(`üì• [${timestamp}] ${messageText}`);
            } else if (message.type === 'noteoff') {
                messageText = `Note Off: ${message.note.number}`;
                updateTestGrid(message.note.number, false);
                log(`üì• [${timestamp}] ${messageText}`);
            }
        }

        function updateTestGrid(midiNote, isPressed) {
            const pad = testGrid[midiNote];
            if (pad) {
                if (isPressed) {
                    pad.classList.add('active');
                    setTimeout(() => {
                        pad.classList.remove('active');
                    }, 200);
                } else {
                    pad.classList.remove('active');
                }
            }
        }

        function createTestGrid() {
            const gridEl = document.getElementById('testGrid');
            
            for (let i = 0; i < 8; i++) {
                const midiNote = i;
                const pad = document.createElement('div');
                pad.className = 'test-pad';
                pad.textContent = midiNote;
                pad.setAttribute('data-note', midiNote);
                
                pad.addEventListener('click', () => {
                    testWebAppToController(midiNote);
                });
                
                testGrid[midiNote] = pad;
                gridEl.appendChild(pad);
            }
        }

        function testWebAppToController(midiNote = 0) {
            log(`üß™ Testing Web App ‚Üí Controller (Note ${midiNote})`);
            
            if (midiOutputs.length === 0) {
                addTestResult('Web App ‚Üí Controller', false, 'No MIDI output devices available');
                return;
            }

            try {
                // Send MIDI message (APC Mini MK2 format)
                midiOutputs.forEach(output => {
                    output.send([0x95, midiNote, 127]); // Note On Channel 5, velocity 127 (white)
                });
                
                // Update visual feedback
                const pad = testGrid[midiNote];
                if (pad) {
                    pad.classList.add('clicked');
                    setTimeout(() => {
                        pad.classList.remove('clicked');
                    }, 500);
                }
                
                addTestResult('Web App ‚Üí Controller', true, `Sent MIDI message for note ${midiNote}`);
                log(`‚úÖ Sent MIDI message: [0x95, ${midiNote}, 127]`);
            } catch (error) {
                addTestResult('Web App ‚Üí Controller', false, `Error: ${error.message}`);
                log(`‚ùå Error sending MIDI: ${error.message}`);
            }
        }

        function testControllerToWebApp() {
            log(`üß™ Testing Controller ‚Üí Web App`);
            
            const inputCount = WebMidi.inputs.length;
            if (inputCount === 0) {
                addTestResult('Controller ‚Üí Web App', false, 'No MIDI input devices available');
                return;
            }

            addTestResult('Controller ‚Üí Web App', true, `Listening to ${inputCount} MIDI input device(s). Press a button on your controller to test.`);
            log(`‚úÖ Ready to receive MIDI input from ${inputCount} device(s)`);
        }

        function testBidirectional() {
            log(`üß™ Testing Bidirectional Communication`);
            
            const inputCount = WebMidi.inputs.length;
            const outputCount = midiOutputs.length;
            
            if (inputCount === 0 || outputCount === 0) {
                addTestResult('Bidirectional Communication', false, `Inputs: ${inputCount}, Outputs: ${outputCount}`);
                return;
            }

            addTestResult('Bidirectional Communication', true, `Inputs: ${inputCount}, Outputs: ${outputCount} - Ready for testing`);
            log(`‚úÖ Bidirectional communication ready - Inputs: ${inputCount}, Outputs: ${outputCount}`);
        }

        function runAllTests() {
            log(`üß™ Running All Tests...`);
            clearTestResults();
            
            // Test 1: Web App ‚Üí Controller
            testWebAppToController(0);
            
            // Test 2: Controller ‚Üí Web App
            testControllerToWebApp();
            
            // Test 3: Bidirectional
            testBidirectional();
            
            log(`‚úÖ All tests completed. Check results above.`);
        }

        function addTestResult(testName, passed, message) {
            const result = {
                name: testName,
                passed: passed,
                message: message,
                timestamp: new Date().toLocaleTimeString()
            };
            
            testResults.push(result);
            updateTestResultsDisplay();
        }

        function updateTestResultsDisplay() {
            const resultsEl = document.getElementById('testResults');
            resultsEl.innerHTML = '';
            
            testResults.forEach(result => {
                const resultDiv = document.createElement('div');
                resultDiv.className = `test-result ${result.passed ? 'pass' : 'fail'}`;
                resultDiv.innerHTML = `
                    <strong>${result.passed ? '‚úÖ' : '‚ùå'} ${result.name}</strong><br>
                    ${result.message}<br>
                    <small>Time: ${result.timestamp}</small>
                `;
                resultsEl.appendChild(resultDiv);
            });
        }

        function clearTestResults() {
            testResults = [];
            updateTestResultsDisplay();
        }

        function log(message) {
            const logEl = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logEl.appendChild(logEntry);
            logEl.scrollTop = logEl.scrollHeight;
        }

        function clearLog() {
            document.getElementById('testLog').innerHTML = '';
        }

        // Initialize test grid when page loads
        document.addEventListener('DOMContentLoaded', createTestGrid);
    </script>
</body>
</html>
